<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive PCs & MCN LSOAs — Unified Metadata Box</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }

    #metadata .metadata-close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 1.2em;
      line-height: 1;
      cursor: pointer;
      color: #103a5e;
    }

    #metadata {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      border: 1px solid #333;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      z-index: 1000;
      pointer-events: auto;
      max-height: 35vh;
      max-width: 75vw;
      overflow-x: auto;
      color: #103a5e;
      font-size: clamp(14px, min(1.25vw, 2.25vh), 25px);
    }

    #metadata table {
      border-collapse: collapse;
      margin-top: 6px;
      max-width: 100%;
    }

    #metadata th, #metadata td {
      padding: 2px 8px;
      border: 1px solid #666;
      text-align: center;
      color: #103a5e;
    }

    #metadata th { background: #eee; }

    .leaflet-tooltip-custom {
      background: rgba(255,255,255,0.95);
      border: 1px solid #333;
      padding: 8px 16px;
      font-size: clamp(14px, 2vh, 24px);
      color: #103a5e;
      border-radius: 4px;
      pointer-events: none;
    }

    .leaflet-control-legend {
      background: white;
      padding: 6px 8px;
      font-size: clamp(14px, 1.5vw, 18px);
      color: #103a5e;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      line-height: 1.4;
    }

    .leaflet-control-legend .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }

    .leaflet-control-legend .legend-item:last-child {
      margin-bottom: 0;
    }

    .leaflet-control-legend .legend-swatch {
      display: inline-block;
      width: 18px;
      height: 18px;
      margin-right: 8px;
      flex-shrink: 0;
    }

    @media (max-width: 600px) {
      #metadata {
        bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="metadata"><em>Select a constituency with MCNs</em></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, pcLayer, highlightLayer, mcnLayer, lsoaHighlightLayer, mcnData;
    let selectedConstituencyName = '';
    let lsoaSelected = false;
    let maxMCNCount = 0; // ✅ Added for dynamic legend
    const metadataDiv = document.getElementById('metadata');
    const baseColors = { 1: '#103a5e', 0: '#DADDD8' };
    const highlightColors = { 1: '#009a9e', 0: '#EAECE9' };
    const isTouchDevice = window.matchMedia('(hover: none)').matches;

    function formatScore(v) {
      const n = parseFloat(v);
      return isNaN(n) ? '' : n.toFixed(2);
    }

    function getColorFromCount(count, maxCount = 20) {
      const scale = Math.min(count / maxCount, 1);
      const start = [170, 180, 190];
      const end = [16, 58, 94];
      const r = Math.round(start[0] + (end[0] - start[0]) * scale);
      const g = Math.round(start[1] + (end[1] - start[1]) * scale);
      const b = Math.round(start[2] + (end[2] - start[2]) * scale);
      return `rgb(${r},${g},${b})`;
    }

    function renderPCMetadata() {
      metadataDiv.innerHTML = '';
      const btn = document.createElement('button');
      btn.className = 'metadata-close-btn';
      btn.innerHTML = '&times;';
      btn.onclick = () => clearAllSelections(true);
      metadataDiv.appendChild(btn);
      const header = document.createElement('div');
	  const code = selectedConstituencyName;
	  const mcnCount = mcnCounts[Object.keys(mcnCounts).find(k => pcLayer.getLayers().some(l => l.feature?.properties?.PCON24CD === k && l.feature.properties.PCON24NM === code))] || 0;
	  header.innerHTML = `<strong>${selectedConstituencyName} – ${mcnCount} MCN${mcnCount !== 1 ? 's' : ''}</strong><br><em>Select an MCN for more details</em>`;
      metadataDiv.appendChild(header);
    }

    function updateMetadataTable(props) {
      metadataDiv.innerHTML = '';
      const btn = document.createElement('button');
      btn.className = 'metadata-close-btn';
      btn.innerHTML = '&times;';
      btn.onclick = () => {
        lsoaHighlightLayer.clearLayers();
        lsoaSelected = false;
        renderPCMetadata();
      };
      metadataDiv.appendChild(btn);

      const header = document.createElement('div');
	  const mcnCount = mcnCounts[selectedConstituencyCode] || 0;
      header.innerHTML = `<strong>${selectedConstituencyName}</strong><br>${props["LSOA (2021) name"]}`;
      metadataDiv.appendChild(header);

      const rows = [
        ["Hyper local need measure",  "Hyper-local need measure score (where higher score = higher need)",  "Hyper-local need measure Rank (where 1 = highest need)"],
        ["Kickstart economic growth", "Kickstart economic growth Score (where higher score = higher need)",    "Kickstart economic growth Rank (where 1 = highest need)"],
        ["Make Britain a clean energy superpower", "Make Britain a clean energy superpower Score (where higher score = higher need)", "Make Britain a clean energy superpower Rank (where 1 = highest need)"],
        ["Take back our streets",      "Take back our streets Score (where higher score = higher need)",      "Take back our streets Rank (where 1 = highest need)"],
        ["Break down barriers to opportunity", "Break down barriers to opportunity Score (where higher score = higher need)", "Break down barriers to opportunity Rank (where 1 = highest need)"],
        ["Build an NHS fit for the future", "Build an NHS fit for the future Score (where higher score = higher need)",   "Build an NHS fit for the future Rank (where 1 = highest need)"]
      ];

      const table = document.createElement('table');
      table.innerHTML = `<thead><tr><th></th><th>Score</th><th>Rank</th></tr></thead>`;
      const tb = document.createElement('tbody');
      rows.forEach(([label, scoreKey, rankKey]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <th>${label}</th>
          <td>${formatScore(props[scoreKey])}</td>
          <td>${props[rankKey] ?? ''}</td>
        `;
        tb.appendChild(tr);
      });
      table.appendChild(tb);
      metadataDiv.appendChild(table);
    }

    function clearMCNLayer() {
      mcnLayer.eachLayer(l => {
        l.off();
        l.unbindTooltip && l.unbindTooltip();
      });
      mcnLayer.clearLayers();
    }

    function clearAllTooltips() {
      map.eachLayer(l => l instanceof L.Tooltip && map.removeLayer(l));
    }

    function clearAllSelections(reset = false) {
      clearAllTooltips();
      highlightLayer.clearLayers();
      lsoaHighlightLayer.clearLayers();
      clearMCNLayer();
      selectedConstituencyName = '';
      lsoaSelected = false;
      if (reset && map.getZoom() > 9) {
        map.setZoom(9);
      }
      metadataDiv.innerHTML = '<em>Select a constituency with MCNs</em>';
    }

    function onPCClick(feature, layer) {
      clearAllSelections();
      selectedConstituencyName = feature.properties.PCON24NM;
	  selectedConstituencyCode = feature.properties.PCON24CD;
      highlightLayer.addData(feature);

      if (feature.properties.has_mcn) {
        renderPCMetadata();
        const code = feature.properties.PCON24CD;
        const matches = mcnData.features.filter(d => d.properties.PCON25CD === code);
        if (matches.length) {
          mcnLayer.addData({ type: 'FeatureCollection', features: matches });
          mcnLayer.bringToFront();
        }
        map.fitBounds(layer.getBounds(), { padding: [30, 30], animate: true, duration: 0.75 });
      } else {
        metadataDiv.innerHTML = '';
        const closeBtn = document.createElement('button');
        closeBtn.className = 'metadata-close-btn';
        closeBtn.innerHTML = '&times;';
        closeBtn.addEventListener('click', () => clearAllSelections(true));
        metadataDiv.appendChild(closeBtn);

        const header = document.createElement('div');
        header.innerHTML = `<strong>${selectedConstituencyName}</strong><br><em>Select a constituency with MCNs</em>`;
        metadataDiv.appendChild(header);
      }
    }

    function onMCNClick(f) {
      lsoaHighlightLayer.clearLayers();
      lsoaHighlightLayer.addData(f);
      lsoaSelected = true;
      updateMetadataTable(f.properties);
    }

    function attachPCHandlers(f, layer) {
      const code = f.properties.PCON24CD;
      const hasMCN = f.properties.has_mcn === 1;
      const fillColor = hasMCN ? getColorFromCount(mcnCounts[code] || 0, maxMCNCount) : baseColors[0];

      layer.defaultStyle = { color: 'white', weight: 1, fillOpacity: 1, fillColor };
      layer.setStyle(layer.defaultStyle);

      let tooltip;
      if (!isTouchDevice) {
	    const mcnCount = window.mcnCounts[code] || 0;
        tooltip = L.tooltip({ direction: 'top', className: 'leaflet-tooltip-custom' })
                   .setContent(`${f.properties.PCON24NM}<br>${mcnCount} MCN${mcnCount !== 1 ? 's' : ''}`);

        layer.on('mouseover', e => {
          tooltip.setLatLng(e.latlng).addTo(map);
          layer.setStyle({
            ...layer.defaultStyle,
            fillColor: hasMCN ? highlightColors[1] : highlightColors[0]
          });
        });
        layer.on('mousemove', e => tooltip.setLatLng(e.latlng));
        layer.on('mouseout', () => {
          map.removeLayer(tooltip);
          layer.setStyle(layer.defaultStyle);
        });
      }

      layer.on('click', () => onPCClick(f, layer));
    }

    function attachMCNHandlers(f, layer) {
      layer.defaultStyle = {
        color: 'white', weight: 1.5,
        fillColor: '#C97064', fillOpacity: 1
      };
      layer.setStyle(layer.defaultStyle);

      let tooltip;
      if (!isTouchDevice) {
        tooltip = L.tooltip({ direction: 'top', className: 'leaflet-tooltip-custom' })
                     .setContent(f.properties["LSOA (2021) name"]);

        layer.on('mouseover', e => {
          tooltip.setLatLng(e.latlng).addTo(map);
          layer.setStyle({ ...layer.defaultStyle, fillColor: '#DA9D95' });
        });
        layer.on('mousemove', e => tooltip.setLatLng(e.latlng));
        layer.on('mouseout', () => {
          map.removeLayer(tooltip);
          layer.setStyle(layer.defaultStyle);
        });
      }

      layer.on('click', () => onMCNClick(f, layer));
    }

    const LegendControl = L.Control.extend({
      options: { position: 'topright' },
      onAdd: function () {
        const div = L.DomUtil.create('div', 'leaflet-control-legend');
        const labelText = maxMCNCount > 1 ? `Constituencies with 1 → ${maxMCNCount} MCNs` : 'MCNs'; // ✅ Dynamic
        div.innerHTML = `
          <div class="legend-item">
            <span class="legend-swatch" style="background:${baseColors[0]}"></span>
            <span>Constituencies with 0 MCNs</span>
          </div>
          <div class="legend-item">
            <span style="
              display: inline-block;
              width: 18px;
              height: 18px;
              background: linear-gradient(to right, rgb(170, 180, 190), rgb(16,58,94));
              border: 1px solid #999;
              margin-right: 8px;
            "></span>
            <span>${labelText}</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch" style="background:#C97064"></span>
            <span>MCNs</span>
          </div>`;
        return div;
      }
    });

    function setupKeyHandler() {
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          if (lsoaSelected) {
            lsoaHighlightLayer.clearLayers();
            lsoaSelected = false;
            renderPCMetadata();
          } else if (selectedConstituencyName) {
            clearAllSelections(true);
          }
        }
      });
    }

    function createMap() {
      map = L.map('map', { maxBounds: [[47, -20], [60, 12]], maxBoundsViscosity: 1.0, minZoom: 7, maxZoom: 18 })
              .setView([53.5, -1.5], 7);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd', attribution: '&copy; OSM &copy; CARTO'
      }).addTo(map);
      map.attributionControl.setPrefix('<a href="https://leafletjs.com">Leaflet</a>');

      highlightLayer = L.geoJSON(null, { style: f => ({ color: 'black', weight:2, fillOpacity: 1, fillColor: highlightColors[f.properties.has_mcn] }) }).addTo(map);
      lsoaHighlightLayer = L.geoJSON(null, { style: { color: 'black', weight: 2, fillColor: '#DA9D95', fillOpacity: 1 } }).addTo(map);
      mcnLayer = L.geoJSON(null, { onEachFeature: attachMCNHandlers }).addTo(map);
      pcLayer = L.geoJSON(null, { onEachFeature: attachPCHandlers }).addTo(map);

      map._legendControl = new LegendControl(); // ✅ Track reference
      map.addControl(map._legendControl);
    }

    async function loadData() {
      try {
        const [pcR, mR] = await Promise.all([
          fetch('PCs_Eng_2025.geojson'),
          fetch('MCN_LSOAs.geojson')
        ]);
        if (!pcR.ok) throw new Error(`PCs load failed: ${pcR.status}`);
        if (!mR.ok) throw new Error(`MCN_LSOAs load failed: ${mR.status}`);

        const [pcGeo, mGeo] = await Promise.all([pcR.json(), mR.json()]);
        mcnData = mGeo;

        window.mcnCounts = {};
        maxMCNCount = 0;
        mcnData.features.forEach(f => {
          const code = f.properties.PCON25CD;
          window.mcnCounts[code] = (window.mcnCounts[code] || 0) + 1;
          if (window.mcnCounts[code] > maxMCNCount) {
            maxMCNCount = window.mcnCounts[code];
          }
        });

        pcLayer.addData(pcGeo);

        map.removeControl(map._legendControl); // ✅ Rebuild legend
        map._legendControl = new LegendControl();
        map.addControl(map._legendControl);
      } catch (err) {
        metadataDiv.innerHTML = `<strong>Error loading data</strong><br>${err.message}`;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      createMap();
      setupKeyHandler();
      loadData();
    });
  </script>
</body>
</html>
